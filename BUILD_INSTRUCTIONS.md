# Инструкция по упаковке и созданию установщика Station App

## 1. Упаковка EXE с помощью PyInstaller

1. **Подготовка среды**:
   - Убедитесь, что все зависимости установлены (`pip install -r requirements.txt`)
   - Проверьте наличие всех необходимых файлов в проекте

2. **Запуск PyInstaller с текущим spec-файлом**:
   ```powershell
   # В корне проекта выполните:
   pyinstaller StationApp.spec
   ```

3. **Результат выполнения**:
   - Готовый EXE файл и необходимые зависимости будут находиться в директории `dist`
   - Временные файлы будут в директории `build`

## 2. Создание установщика с помощью Inno Setup

1. **Запуск скрипта сборки установщика**:
   ```powershell
   # В корне проекта выполните:
   .\build_installer.bat
   ```

2. **Результат выполнения**:
   - Установщик будет создан в директории `installer`
   - Имя файла установщика: `ECDC_StationApp_Installer_X.Y.Z.exe` (где X.Y.Z - версия из файла `version.txt`)

## 3. Вносим изменения в установщик

Если нужно добавить новые файлы или изменить поведение установщика:

1. **Редактирование скрипта Inno Setup**:
   - Откройте файл `StationApp_Setup.iss` в текстовом редакторе

2. **Основные секции для модификации**:
   
   - **Добавление файлов**:
     ```
     [Files]
     Source: "dist\новый_файл.dll"; DestDir: "{app}"; Flags: ignoreversion
     Source: "dist\новая_папка\*"; DestDir: "{app}\новая_папка"; Flags: ignoreversion recursesubdirs createallsubdirs
     ```

   - **Запуск скриптов установки**:
     ```
     [Run]
     Filename: "{cmd}"; \
       Parameters: "/C cd ""{app}\utils"" && ваш_скрипт.bat"; \
       Description: "Описание действия..."; \
       StatusMsg: "Сообщение пользователю..."; \
       Flags: shellexec waituntilterminated runasoriginaluser
     ```

   - **Создание ярлыков**:
     ```
     [Icons]
     Name: "{commondesktop}\Имя ярлыка"; Filename: "{app}\имя_программы.exe"; WorkingDir: "{app}"; IconFilename: "{app}\путь_к_иконке.ico"
     ```

3. **Специальные замечания**:
   - Для запуска с правами администратора используйте флаг `runasoriginaluser` вместе с `shellexec`
   - Для выполнения скриптов в нужной директории используйте: `/C cd ""{app}\utils"" && имя_скрипта.bat`
   - `{app}` - путь к директории установки приложения
   - При необходимости изменения версии установщика обновите файл `version.txt` или параметр `OutputBaseFilename` в секции `[Setup]`

## 4. Важные файлы для настройки поведения

1. **StationApp.spec** - конфигурация PyInstaller для упаковки EXE
   - Путь: `c:\Users\94500062\station-app\ecdc\StationApp.spec`
   - Редактируйте для изменения способа упаковки, включения ресурсов или DLL

2. **StationApp_Setup.iss** - скрипт для Inno Setup
   - Путь: `c:\Users\94500062\station-app\ecdc\StationApp_Setup.iss`
   - Редактируйте для изменения процесса установки

3. **build_installer.bat** - скрипт для запуска Inno Setup
   - Путь: `c:\Users\94500062\station-app\ecdc\build_installer.bat`
   - Запускает компиляцию Inno Setup

4. **create_odbc_dsn.bat** и **fanuc_portable_setup.bat** - скрипты настройки
   - Путь: `c:\Users\94500062\station-app\ecdc\src\utils\`
   - Выполняются во время установки для настройки системы

## 5. Памятка по работе с администраторскими правами

- Для корректного запуска скриптов с правами администратора:
  - Убедитесь, что в `[Setup]` установлен параметр `PrivilegesRequired=admin`
  - Используйте флаги `shellexec` и `runasoriginaluser` для команд в секции `[Run]`
  - Запускайте установщик от имени администратора

- Скрипты, которые работают с реестром, должны использовать флаг `/reg:64` для 64-битных операций, даже если запускаются из 32-битного установщика

## 6. Полный процесс обновления и создания установщика

```powershell
# 1. Обновите версию в файле version.txt (если нужно)
# 2. Упакуйте приложение с помощью PyInstaller
pyinstaller StationApp.spec

# 3. При необходимости скопируйте дополнительные файлы в dist/
# (например, если нужны файлы, которые не включены в spec-файл)

# 4. Запустите сборку установщика
.\build_installer.bat

# 5. Проверьте результат в директории installer
# Готовый файл: installer\ECDC_StationApp_Installer_X.Y.Z.exe
```

Следуя этой инструкции, вы сможете быстро создать новую версию установщика для StationApp с учетом всех необходимых настроек и скриптов.
